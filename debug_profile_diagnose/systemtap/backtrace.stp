#!/usr/bin/stap

global bt_stats
global quit

probe begin {
    warn("Start tracing. Wait for 10 sec to complete.\n")
}

probe kernel.function("memcpy") {
    if (pid() == target()) {
        if (quit) {
            foreach (bt in bt_stats) {
                print_ustack(bt)
                printf("\t%d\n\n", @count(bt_stats[bt]))
            }
            exit()
        } else {
            bt = ubacktrace()
            bt_stats[bt] <<< 1
        }

    }
}

probe timer.s(1) {
    quit = 1
}