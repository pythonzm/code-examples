## ç«ç„°å›¾ä½¿ç”¨

1. é¦–å…ˆå®‰è£…ä¾èµ–å‘½ä»¤

`install_perf_in_ubuntu.sh`è„šæœ¬ç”¨æ¥å®‰è£…perfå‘½ä»¤å’ŒBrendan D. Greggçš„Flame Graphå·¥å…·åŒ…

2. cpué‡‡æ ·å¹¶ç”Ÿæˆç«ç„°å›¾

è¿™é‡Œé¢æ˜¯åˆ©ç”¨perfå‘½ä»¤ç”Ÿæˆç«ç„°å›¾ã€‚åˆ†ä¸ºä¸‰æ­¥èµ°ï¼š

- ç¬¬ä¸€æ­¥æ˜¯**é‡‡æ ·ç¨‹åºè¿è¡Œçš„å †æ ˆ**ï¼Œè¿™ä¸€æ­¥åˆ©ç”¨perf/systemtapç­‰traceå·¥å…·ã€‚

    sudo perf record -F 99 -p 8900 -g -o $perfFile -- sleep 60 
    - perf record ç”¨äºé‡‡é›†äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨-eæŒ‡å®šé‡‡é›†äº‹ä»¶
    - -F 99è¡¨ç¤ºæ¯ç§’é‡‡æ ·99æ¬¡
    - -p 8900æŒ‡å®šé‡‡æ ·çš„è¿›ç¨‹
    - -gè¡¨ç¤ºè®°å½•è°ƒç”¨æ ˆä¿¡æ¯
    - -o perfileè¡¨ç¤ºé‡‡æ ·æ•°æ®è¾“å‡ºåˆ°perfileæ–‡ä»¶ä¸­
    - -- sleep 60è¡¨ç¤ºé‡‡æ ·60s


- ç¬¬äºŒæ­¥æ˜¯**æŠ˜å å †æ ˆ**ï¼Œè¿™æ˜¯å› ä¸ºç¬¬ä¸€æ­¥é‡‡æ ·çš„æ˜¯ç³»ç»Ÿå’Œç¨‹åºè¿è¡Œæ¯ä¸€æ—¶åˆ»çš„å †æ ˆä¿¡æ¯, éœ€è¦å¯¹ä»–ä»¬è¿›è¡Œåˆ†æç»„åˆ, å°†é‡å¤çš„å †æ ˆç´¯è®¡åœ¨ä¸€èµ·, ä»è€Œä½“ç°å‡ºè´Ÿè½½å’Œå…³é”®è·¯å¾„ã€‚è¿™ä¸€æ­¥åˆ©ç”¨çš„æ˜¯Flame Graphå·¥å…·åŒ…ä¸­çš„ stackcollapse ç¨‹åºã€‚

    - perf script -i perf.data &> perf.unfold

        å¯¹ç¬¬ä¸€æ­¥ä¸­é‡‡é›†çš„perf.dataæ•°æ®è¿›è¡Œè§£æ
    - ./stackcollapse-perf.pl perf.unfold &> perf.folded

        è¿›è¡ŒæŠ˜å å †æ ˆå¤„ç†

- ç¬¬ä¸‰æ­¥æ˜¯**ç”Ÿæˆç«ç„°å›¾ğŸ”¥**ï¼Œåˆ©ç”¨Flame Graphå·¥å…·åŒ…ä¸­flamegraph.plåˆ†æstackcollapse è¾“å‡ºçš„å †æ ˆä¿¡æ¯ç”Ÿæˆç«ç„°å›¾

    - ./flamegraph.pl perf.folded > perf.svg

        ç”Ÿæˆç«ç„°å›¾

ä¸Šé¢ä¸‰æ­¥èµ°æµç¨‹å¯ä»¥é€šè¿‡ç®¡é“ç®€åŒ–æˆä¸€æ¡å‘½ä»¤ï¼Œå…·ä½“è§cpu.sh


3. åˆ†æç«ç„°å›¾

**ç«ç„°å›¾å«ä¹‰ï¼š**

ç«ç„°å›¾æ˜¯åŸºäº stack ä¿¡æ¯ç”Ÿæˆçš„ SVG å›¾ç‰‡, ç”¨æ¥å±•ç¤º CPU çš„è°ƒç”¨æ ˆã€‚

y è½´è¡¨ç¤ºè°ƒç”¨æ ˆ, æ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°. è°ƒç”¨æ ˆè¶Šæ·±, ç«ç„°å°±è¶Šé«˜, é¡¶éƒ¨å°±æ˜¯æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°, ä¸‹æ–¹éƒ½æ˜¯å®ƒçš„çˆ¶å‡½æ•°.

x è½´è¡¨ç¤ºæŠ½æ ·æ•°, å¦‚æœä¸€ä¸ªå‡½æ•°åœ¨ x è½´å æ®çš„å®½åº¦è¶Šå®½, å°±è¡¨ç¤ºå®ƒè¢«æŠ½åˆ°çš„æ¬¡æ•°å¤š, å³æ‰§è¡Œçš„æ—¶é—´é•¿. æ³¨æ„, x è½´ä¸ä»£è¡¨æ—¶é—´, è€Œæ˜¯æ‰€æœ‰çš„è°ƒç”¨æ ˆåˆå¹¶å, æŒ‰å­—æ¯é¡ºåºæ’åˆ—çš„.

ç«ç„°å›¾å°±æ˜¯çœ‹é¡¶å±‚çš„å“ªä¸ªå‡½æ•°å æ®çš„å®½åº¦æœ€å¤§. åªè¦æœ‰ "å¹³é¡¶"(plateaus), å°±è¡¨ç¤ºè¯¥å‡½æ•°å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚

é¢œè‰²æ²¡æœ‰ç‰¹æ®Šå«ä¹‰, å› ä¸ºç«ç„°å›¾è¡¨ç¤ºçš„æ˜¯ CPU çš„ç¹å¿™ç¨‹åº¦, æ‰€ä»¥ä¸€èˆ¬é€‰æ‹©æš–è‰²è°ƒ.

**ç«ç„°å›¾ä½¿ç”¨ï¼š**

- é¼ æ ‡æ‚¬æµ®

ç«ç„°çš„æ¯ä¸€å±‚éƒ½ä¼šæ ‡æ³¨å‡½æ•°å, é¼ æ ‡æ‚¬æµ®æ—¶ä¼šæ˜¾ç¤ºå®Œæ•´çš„å‡½æ•°åã€æŠ½æ ·æŠ½ä¸­çš„æ¬¡æ•°ã€å æ®æ€»æŠ½æ ·æ¬¡æ•°çš„ç™¾åˆ†æ¯”ã€‚æ¯”å¦‚ï¼šFunctionï¼šmain(3866 samples, 98.67%)


- ç‚¹å‡»æ”¾å¤§

åœ¨æŸä¸€å±‚ç‚¹å‡»ï¼Œç«ç„°å›¾ä¼šæ°´å¹³æ”¾å¤§ï¼Œè¯¥å±‚ä¼šå æ®æ‰€æœ‰å®½åº¦ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ã€‚

å·¦ä¸Šè§’ä¼šåŒæ—¶æ˜¾ç¤º "Reset Zoom", ç‚¹å‡»è¯¥é“¾æ¥, å›¾ç‰‡å°±ä¼šæ¢å¤åŸæ ·.


**å±€é™æ€§ï¼š**

- è°ƒç”¨æ ˆä¸å®Œæ•´

å½“è°ƒç”¨æ ˆè¿‡æ·±æ—¶ï¼ŒæŸäº›ç³»ç»Ÿåªè¿”å›å‰é¢çš„ä¸€éƒ¨åˆ†ï¼ˆæ¯”å¦‚å‰10å±‚ï¼‰ã€‚

- å‡½æ•°åç¼ºå¤±

æœ‰äº›å‡½æ•°æ²¡æœ‰åå­—ï¼Œç¼–è¯‘å™¨åªç”¨å†…å­˜åœ°å€æ¥è¡¨ç¤ºï¼ˆæ¯”å¦‚åŒ¿åå‡½æ•°ï¼‰ã€‚

## çº¢è“åˆ†å‰ç«ç„°å›¾

ä¸Šé¢ä»‹ç»çš„ç«ç„°å›¾å¯èƒ½å¾ˆå¥½å®šä½åˆ°CPUè´Ÿè½½é—®é¢˜ï¼Œä½†å¯¹äºæ€§èƒ½å›é€€é—®é¢˜ï¼Œæ¯”å¦‚å‘å¸ƒæ–°ç‰ˆæœ¬ä¹‹åè½¯ä»¶çš„æ€§èƒ½ç›¸æ¯”æ—§ç‰ˆæœ¬æœ‰æ‰€ä¸‹é™ï¼Œå¯¹äºè¿™ç±»çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¢/è“å·®åˆ†ç«ç„°å›¾(red/blue differential flame graphs)ã€‚

**å·¥ä½œåŸç†ï¼š**

- æŠ“å–ä¿®æ”¹å‰çš„å †æ ˆ profile1 æ–‡ä»¶

- æŠ“å–ä¿®æ”¹åçš„å †æ ˆ profile2 æ–‡ä»¶

- ä½¿ç”¨ profile2 æ¥ç”Ÿæˆç«ç„°å›¾. (è¿™æ ·æ ˆå¸§çš„å®½åº¦å°±æ˜¯ä»¥profile2 æ–‡ä»¶ä¸ºåŸºå‡†çš„)

- ä½¿ç”¨ "2-1" çš„å·®å¼‚æ¥å¯¹ç«ç„°å›¾é‡æ–°ä¸Šè‰². ä¸Šè‰²çš„åŸåˆ™æ˜¯, å¦‚æœæ ˆå¸§åœ¨ profile2 ä¸­å‡ºç°å‡ºç°çš„æ¬¡æ•°æ›´å¤š, åˆ™æ ‡ä¸ºçº¢è‰², å¦åˆ™æ ‡ä¸ºè“è‰². è‰²å½©æ˜¯æ ¹æ®ä¿®æ”¹å‰åçš„å·®å¼‚æ¥å¡«å……çš„.

**ä½¿ç”¨ï¼š**

```
# æ—§ä»£ç è¿è¡Œåæ•°æ®
perf record -F 99 -a -g -- sleep 30 # é‡‡é›†æ•°æ®
perf script > out.stacks1 #	è§£ææ•°æ®ç”Ÿæˆå †æ ˆä¿¡æ¯
./stackcollapse-perf.pl ../out.stacks1 > out.folded1 #	æŠ˜å å †æ ˆ


# æ–°ä»£ç è¿è¡Œåæ•°æ®
perf record -F 99 -a -g -- sleep 30 # é‡‡é›†æ•°æ®
perf script > out.stacks2 #	è§£ææ•°æ®ç”Ÿæˆå †æ ˆä¿¡æ¯
./stackcollapse-perf.pl ../out.stacks2 > out.folded2 #	æŠ˜å å †æ ˆ

# ç”Ÿæˆçº¢è“å·®åˆ†ç«ç„°å›¾

# å®½åº¦æ˜¯ä»¥ä¿®æ”¹åprofileæ–‡ä»¶ä¸ºåŸºå‡†ï¼Œé¢œè‰²è¡¨æ˜å·²ç»å‘ç”Ÿçš„æƒ…å†µ
./difffolded.pl out.folded1 out.folded2 | ./flamegraph.pl > diff2.svg

# å®½åº¦æ˜¯ä»¥ä¿®æ”¹å‰profileæ–‡ä»¶ä¸ºåŸºå‡†ï¼Œé¢œè‰²è¡¨æ˜å°†è¦å‘ç”Ÿçš„æƒ…å†µ
./difffolded.pl out.folded2 out.folded1 | ./flamegraph.pl --negate > diff1.svg
```

## èµ„æ–™

- [Linuxä¸‹ç”¨ç«ç„°å›¾è¿›è¡Œæ€§èƒ½åˆ†æ](https://github.com/gatieme/LDD-LinuxDeviceDrivers/tree/master/study/debug/tools/perf/flame_graph#linux%E4%B8%8B%E7%94%A8%E7%81%AB%E7%84%B0%E5%9B%BE%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90)
- [Blazing Performance with Flame Graphs](http://www.slideshare.net/brendangregg/blazing-performance-with-flame-graphs)
- [Choosing a Linux Tracer](https://www.brendangregg.com/blog/2015-07-08/choosing-a-linux-tracer.html)
- [Linux Profiling at Netflix](http://www.slideshare.net/brendangregg/scale2015-linux-perfprofiling)
- [Flame Graph](https://github.com/brendangregg/FlameGraph)
- [Broken Linux Performance Tools 2016](https://www.slideshare.net/brendangregg/broken-linux-performance-tools-2016?next_slideshow=1)